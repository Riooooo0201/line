<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}佐藤日記くん{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <main>
        {% block content %}
            <div id="user-greeting"></div>
            <hr>
            <a href="{{ url_for('index') }}">ホーム</a>
            <a href="{{ url_for('mypage') }}">マイページ</a>
            <a href="{{ url_for('posts') }}">投稿一覧</a>
            <a href="{{ url_for('rules') }}">利用規約</a>
        {% endblock %}
    </main>

    <footer>
        <p>&copy; 佐藤日記くん</p>
    </footer>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js"; ←ローカルでは無効化推奨

        const firebaseConfig = {
            apiKey: "AIzaSyC0WD08-fXa3WG6E4_NBfSFe92mt5g75II",
            authDomain: "satounikikun.firebaseapp.com",
            projectId: "satounikikun",
            storageBucket: "satounikikun.firebasestorage.app",
            messagingSenderId: "33218781413",
            appId: "1:33218781413:web:7f296ed9e5f69db178f40c",
            measurementId: "G-721M45FHJM"
        };

        const app = initializeApp(firebaseConfig);
        // const analytics = getAnalytics(app);
    </script>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        async function main() {
            try {
                await liff.init({ liffId: "2008454581-9AVyN4Jv" });

                if (liff.isLoggedIn()) {
                    let userProfile = null;
                    let userName = "ゲスト";

                    try {
                        const decodedToken = await liff.getDecodedIDToken();
                        userProfile = decodedToken;
                        userName = userProfile.name;
                    } catch (tokenError) {
                        console.error("IDトークンのデコードに失敗しました。:", tokenError);
                        // フォールバックとしてliff.getProfile()を試すことも可能だが、
                        // 今回はIDトークンで取得できたため、ここでは省略
                    }

                    if (userProfile) {
                        const userGreeting = document.getElementById('user-greeting');
                        if (userGreeting) {
                            userGreeting.innerText = `ようこそ、${userName}さん！`;
                        }
                        document.body.dispatchEvent(new CustomEvent('liff-ready', { detail: { profile: userProfile } }));
                    }

                } else {
                    liff.login();
                }
            } catch (error) {
                console.error("LIFFの処理中にエラーが発生しました。", error);
            }
        }
        main();
    </script>
</body>
</html>
